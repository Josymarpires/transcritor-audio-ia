import React, { useState, useRef, useEffect } from ‚Äòreact‚Äô;
import { Mic, Upload, Copy, Download, Loader, CheckCircle, XCircle, FileAudio, Wifi, WifiOff } from ‚Äòlucide-react‚Äô;

export default function AudioTranscriber() {
const [recording, setRecording] = useState(false);
const [audioBlob, setAudioBlob] = useState(null);
const [audioFile, setAudioFile] = useState(null);
const [transcription, setTranscription] = useState(‚Äô‚Äô);
const [loading, setLoading] = useState(false);
const [error, setError] = useState(‚Äô‚Äô);
const [success, setSuccess] = useState(‚Äô‚Äô);
const [recordingTime, setRecordingTime] = useState(0);

const mediaRecorderRef = useRef(null);
const audioChunksRef = useRef([]);
const timerRef = useRef(null);
const fileInputRef = useRef(null);

useEffect(() => {
return () => {
if (timerRef.current) clearInterval(timerRef.current);
};
}, []);

const startRecording = async () => {
try {
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
mediaRecorderRef.current = new MediaRecorder(stream);
audioChunksRef.current = [];

```
  mediaRecorderRef.current.ondataavailable = (event) => {
    audioChunksRef.current.push(event.data);
  };

  mediaRecorderRef.current.onstop = () => {
    const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
    setAudioBlob(blob);
    setAudioFile(null);
    stream.getTracks().forEach(track => track.stop());
  };

  mediaRecorderRef.current.start();
  setRecording(true);
  setRecordingTime(0);
  setError('');
  setSuccess('');
  setTranscription('');

  timerRef.current = setInterval(() => {
    setRecordingTime(prev => prev + 1);
  }, 1000);
} catch (err) {
  setError('Erro ao acessar microfone. Verifique as permiss√µes.');
}
```

};

const stopRecording = () => {
if (mediaRecorderRef.current && recording) {
mediaRecorderRef.current.stop();
setRecording(false);
if (timerRef.current) {
clearInterval(timerRef.current);
timerRef.current = null;
}
setSuccess(‚Äò√Åudio gravado com sucesso!‚Äô);
}
};

const handleFileImport = (event) => {
const file = event.target.files[0];
if (file) {
const validTypes = [‚Äòaudio/wav‚Äô, ‚Äòaudio/mpeg‚Äô, ‚Äòaudio/mp3‚Äô, ‚Äòaudio/mp4‚Äô, ‚Äòaudio/x-m4a‚Äô];
if (validTypes.includes(file.type) || file.name.endsWith(‚Äô.m4a‚Äô)) {
setAudioFile(file);
setAudioBlob(null);
setError(‚Äô‚Äô);
setSuccess(‚Äò√Åudio importado com sucesso!‚Äô);
setTranscription(‚Äô‚Äô);
} else {
setError(‚ÄòFormato n√£o suportado. Use WAV, MP3 ou M4A.‚Äô);
}
}
};

const transcribeOnline = async () => {
const audioToSend = audioFile || audioBlob;

```
if (!audioToSend) {
  setError('Grave ou importe um √°udio primeiro.');
  return;
}

setLoading(true);
setError('');
setSuccess('');

const formData = new FormData();
if (audioFile) {
  formData.append('audio', audioFile);
} else {
  formData.append('audio', audioBlob, 'recording.webm');
}

try {
  const response = await fetch('/transcrever', {
    method: 'POST',
    body: formData,
  });

  if (!response.ok) {
    throw new Error(`Erro ${response.status}: ${response.statusText}`);
  }

  const data = await response.json();
  setTranscription(data.texto || data.text || '');
  setSuccess('Transcri√ß√£o conclu√≠da!');
} catch (err) {
  setError(`Erro na transcri√ß√£o: ${err.message}`);
  // Simula√ß√£o para demonstra√ß√£o (remover em produ√ß√£o)
  console.log('Modo demonstra√ß√£o - endpoint n√£o dispon√≠vel');
  setTranscription('Esta √© uma transcri√ß√£o de demonstra√ß√£o. Configure o endpoint /transcrever para usar a transcri√ß√£o real.');
} finally {
  setLoading(false);
}
```

};

const transcribeOffline = () => {
setError(‚Äô‚Äô);
setSuccess(‚Äô‚Äô);
alert(‚ÄòModo offline dispon√≠vel em vers√£o avan√ßada.\n\nEm breve: transcri√ß√£o local usando modelos de IA executados no navegador.‚Äô);
};

const copyText = () => {
if (transcription) {
navigator.clipboard.writeText(transcription);
setSuccess(‚ÄòTexto copiado!‚Äô);
}
};

const exportTxt = () => {
if (transcription) {
const blob = new Blob([transcription], { type: ‚Äòtext/plain‚Äô });
const url = URL.createObjectURL(blob);
const a = document.createElement(‚Äòa‚Äô);
a.href = url;
a.download = `transcricao_${new Date().getTime()}.txt`;
a.click();
URL.revokeObjectURL(url);
setSuccess(‚ÄòArquivo exportado!‚Äô);
}
};

const formatTime = (seconds) => {
const mins = Math.floor(seconds / 60);
const secs = seconds % 60;
return `${mins}:${secs.toString().padStart(2, '0')}`;
};

return (
<div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
<div className="max-w-2xl mx-auto">
{/* Header */}
<header className="text-center mb-8 pt-6">
<div className="inline-block p-3 bg-indigo-600 rounded-2xl mb-4">
<FileAudio className="w-10 h-10 text-white" />
</div>
<h1 className="text-3xl font-bold text-gray-800 mb-2">
Transcritor de √Åudio IA
</h1>
<p className="text-gray-600">
Grave ou importe √°udio e transcreva com intelig√™ncia artificial
</p>
</header>

```
    {/* Messages */}
    {error && (
      <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
        <XCircle className="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" />
        <p className="text-red-700 text-sm">{error}</p>
      </div>
    )}
    
    {success && (
      <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3">
        <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" />
        <p className="text-green-700 text-sm">{success}</p>
      </div>
    )}

    {/* Recording Section */}
    <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <h2 className="text-lg font-semibold text-gray-800 mb-4">
        Gravar √Åudio
      </h2>
      
      {recording && (
        <div className="mb-4 p-4 bg-red-50 rounded-lg text-center">
          <div className="flex items-center justify-center gap-2 mb-2">
            <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            <span className="text-red-700 font-semibold">Gravando</span>
          </div>
          <p className="text-2xl font-mono text-gray-800">
            {formatTime(recordingTime)}
          </p>
        </div>
      )}

      <div className="flex gap-3">
        {!recording ? (
          <button
            onClick={startRecording}
            className="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2"
          >
            <Mic className="w-5 h-5" />
            Iniciar Grava√ß√£o
          </button>
        ) : (
          <button
            onClick={stopRecording}
            className="flex-1 bg-red-600 text-white py-4 rounded-xl font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2"
          >
            <div className="w-5 h-5 border-2 border-white rounded"></div>
            Parar Grava√ß√£o
          </button>
        )}
      </div>
    </div>

    {/* Import Section */}
    <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <h2 className="text-lg font-semibold text-gray-800 mb-4">
        Importar √Åudio
      </h2>
      
      <input
        ref={fileInputRef}
        type="file"
        accept="audio/wav,audio/mp3,audio/mpeg,audio/m4a,audio/mp4"
        onChange={handleFileImport}
        className="hidden"
      />
      
      <button
        onClick={() => fileInputRef.current?.click()}
        disabled={recording}
        className="w-full bg-gray-100 text-gray-800 py-4 rounded-xl font-semibold hover:bg-gray-200 transition flex items-center justify-center gap-2 disabled:opacity-50"
      >
        <Upload className="w-5 h-5" />
        Selecionar Arquivo (WAV, MP3, M4A)
      </button>
      
      {audioFile && (
        <p className="mt-3 text-sm text-gray-600 text-center">
          üìé {audioFile.name}
        </p>
      )}
      
      {audioBlob && !audioFile && (
        <p className="mt-3 text-sm text-gray-600 text-center">
          üé§ Grava√ß√£o capturada ({formatTime(recordingTime)})
        </p>
      )}
    </div>

    {/* Transcribe Section */}
    <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <h2 className="text-lg font-semibold text-gray-800 mb-4">
        Transcrever
      </h2>
      
      <div className="flex flex-col gap-3">
        <button
          onClick={transcribeOnline}
          disabled={loading || recording || (!audioBlob && !audioFile)}
          className="bg-indigo-600 text-white py-4 rounded-xl font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {loading ? (
            <>
              <Loader className="w-5 h-5 animate-spin" />
              Transcrevendo...
            </>
          ) : (
            <>
              <Wifi className="w-5 h-5" />
              Transcrever Online
            </>
          )}
        </button>
        
        <button
          onClick={transcribeOffline}
          disabled={loading || recording}
          className="bg-gray-200 text-gray-700 py-4 rounded-xl font-semibold hover:bg-gray-300 transition flex items-center justify-center gap-2 disabled:opacity-50"
        >
          <WifiOff className="w-5 h-5" />
          Transcrever Offline (Em breve)
        </button>
      </div>
    </div>

    {/* Transcription Result */}
    {transcription && (
      <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <h2 className="text-lg font-semibold text-gray-800 mb-4">
          Transcri√ß√£o
        </h2>
        
        <div className="bg-gray-50 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto">
          <p className="text-gray-800 whitespace-pre-wrap">
            {transcription}
          </p>
        </div>
        
        <div className="flex gap-3">
          <button
            onClick={copyText}
            className="flex-1 bg-indigo-100 text-indigo-700 py-3 rounded-xl font-semibold hover:bg-indigo-200 transition flex items-center justify-center gap-2"
          >
            <Copy className="w-5 h-5" />
            Copiar
          </button>
          
          <button
            onClick={exportTxt}
            className="flex-1 bg-green-100 text-green-700 py-3 rounded-xl font-semibold hover:bg-green-200 transition flex items-center justify-center gap-2"
          >
            <Download className="w-5 h-5" />
            Exportar TXT
          </button>
        </div>
      </div>
    )}

    {/* Footer */}
    <footer className="text-center text-sm text-gray-600 pb-6">
      <p className="mb-2">
        üîí Seus √°udios n√£o s√£o armazenados
      </p>
      <p>
        <a href="#privacy" className="text-indigo-600 hover:underline">
          Pol√≠tica de Privacidade
        </a>
      </p>
    </footer>
  </div>
</div>
```

);
}
